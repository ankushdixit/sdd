# Lightweight PR validation workflow
# Runs Phase 1 tests (16 core tests) on every PR
# For full Phase 4 testing, use: ./scripts/run-gcp-tests.sh

name: PR Validation

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'analysis-docs/test_all_templates.py'
  workflow_dispatch:  # Allow manual triggering

jobs:
  # Quick smoke test - Phase 1 only (16 tests)
  smoke-test:
    name: Phase 1 Smoke Tests
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install solokit
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Configure git identity
        run: |
          git config --global user.email "solokit-test@example.com"
          git config --global user.name "Solokit Test Runner"

      - name: Run Phase 1 Tests (Core Matrix)
        run: |
          python analysis-docs/test_all_templates.py \
            --phase 1 \
            --incomplete \
            --workers 2 \
            --no-cleanup

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-phase1
          path: analysis-docs/test_results/

  # Status check that summarizes results
  pr-status:
    name: PR Status Check
    needs: [smoke-test]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Check test results
        run: |
          if [ "${{ needs.smoke-test.result }}" == "success" ]; then
            echo "✅ Phase 1 smoke tests passed!"
            echo ""
            echo "For full Phase 4 validation (192 tests), run locally:"
            echo "  ./scripts/run-gcp-tests.sh"
          else
            echo "❌ Phase 1 smoke tests failed"
            exit 1
          fi
